name: EAS Update

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "EAS Branch"
        type: choice
        default: main
        required: true
        options:
          - preview
          - production
      confirm:
        description: "Confirm production update"
        type: boolean
        required: true
        default: false

jobs:
  update:
    name: EAS Update
    runs-on: ubuntu-latest

    steps:
      - name: üöö Checkout
        uses: actions/checkout@v3
      - name: üèó Setup monorepo
        uses: ./.github/actions/setup-monorepo
        with:
          expo-token: ${{ secrets.EXPO_TOKEN }}
      - name: üì¢ Publish update (production)
        run: eas update --non-interactive -p ios --branch=${{ inputs.branch }} --message=${{ github.sha }}
        working-directory: ./apps/app
        if: ${{ inputs.branch != 'production' }}
        env:
          TAMAGUI_TARGET: "native"
          EXPO_PUBLIC_POSTHOG_API_KEY: ${{ secrets.EXPO_PUBLIC_POSTHOG_API_KEY_STAGING }}
          EXPO_PUBLIC_MIXPANEL_TOKEN: ${{ secrets.EXPO_PUBLIC_MIXPANEL_TOKEN_STAGING }}
          EXPO_PUBLIC_ONESIGNAL_APP_ID: ${{ secrets.EXPO_PUBLIC_ONESIGNAL_APP_ID_STAGING }}
          EXPO_PUBLIC_SENTRY_DSN: ${{ secrets.EXPO_PUBLIC_SENTRY_DSN_STAGING }}
          EXPO_PUBLIC_VEXO_API_KEY: ${{ secrets.EXPO_PUBLIC_VEXO_API_KEY_STAGING }}
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL_STAGING }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY_STAGING }}
      - name: üì¢ Publish update (production)
        run: eas update --non-interactive -p ios --branch=production --message=${{ github.sha }}
        working-directory: ./apps/app
        if: ${{ inputs.confirm && inputs.branch == 'production' }}
        env:
          TAMAGUI_TARGET: "native"
          EXPO_PUBLIC_POSTHOG_API_KEY: ${{ secrets.EXPO_PUBLIC_POSTHOG_API_KEY_PRODUCTION }}
          EXPO_PUBLIC_MIXPANEL_TOKEN: ${{ secrets.EXPO_PUBLIC_MIXPANEL_TOKEN_PRODUCTION }}
          EXPO_PUBLIC_ONESIGNAL_APP_ID: ${{ secrets.EXPO_PUBLIC_ONESIGNAL_APP_ID_PRODUCTION }}
          EXPO_PUBLIC_SENTRY_DSN: ${{ secrets.EXPO_PUBLIC_SENTRY_DSN_PRODUCTION }}
          EXPO_PUBLIC_VEXO_API_KEY: ${{ secrets.EXPO_PUBLIC_VEXO_API_KEY_PRODUCTION }}
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL_PRODUCTION }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY_PRODUCTION }}
